URI=en-US/splunkd/__raw/services/search/shelper?output_mode=json&snippet=true&snippetEmbedJS=false&namespace=search&search=search+jon.smith%40gmail.com+&useTypeahead=true&useAssistant=false&showCommandHelp=true&showCommandHistory=true&showFieldInfo=false&_=1599549840486
URI=en-US/splunkd/__raw/services/search/shelper?output_mode=json&snippet=true&snippetEmbedJS=false&namespace=search&search=search+peterjones32%40gmail.com+&useTypeahead=true&useAssistant=false&showCommandHelp=true&showCommandHistory=true&showFieldInfo=false&_=1599549840487
NAME=hmrc-960-nginx-test
URI=/en-GB/splunkd/__raw/services/search/shelper?output_mode=json&snippet=true&snippetEmbedJS=false&namespace=splunk-sam-dashboards-app&search=search+(%0A++++(%0A++++index%3D%22dg_self-employed-income-support-frontend%22+%0A++++sourcetype%3D%22dg%3Aself-employed-income-support-frontend%3AClaimSubmitted%22+%0A++++)+OR%0A++++(%0A++++index%3D%22dg_self-employed-income-support-stride-frontend%22+%0A++++sourcetype%3D%22dg%3Aself-employed-income-support-stride-frontend%3AClaimSubmitted%22%0A++++)%0A++++)+%0A++++%5B+search+(+(+index%3D%22dg_self-employed-income-support-frontend%22+sourcetype%3D%22dg%3Aself-employed-income-support-frontend%3AClaimSubmitted%22+)+OR+(+index%3D%22dg_self-employed-income-support-stride-frontend%22+sourcetype%3D%22dg%3Aself-employed-income-support-stride-frontend%3AClaimSubmitted%22+)+)+%0A++++++++%5B+search+index%3Devents_of_interest+userEmailAddress%3D%22billybob%40gmail.com%22+OR+userEmailAddress%3D%22bertybarr%40gmail.com%22+%0A++++++++%7C+table+userId%7B%7D+%0A++++++++%7C+dedup+userId%7B%7D+%0A++++++++%7C+rename+userId%7B%7D+AS+detail.credId%5D+%0A++++%7C+stats+count+by+detail.userEnteredClaimDetails.bankAccountDetails.sortCode%2C+detail.userEnteredClaimDetails.bankAccountDetails.accountNumber+%0A++++%7C+table+detail.userEnteredClaimDetails.bankAccountDetails.sortCode%2C+detail.userEnteredClaimDetails.bankAccountDetails.accountNumber+%5D+%0A%7C+nomv+detail.userEnteredClaimDetails.bankAccountDetails.address.lines%7B%7D%7B%7D+%0A%7C+fillnull+value%3D%221%22+detail.phase+%0A%7C+fillnull+value%3Dnull+detail.allowedClaimReason+%0A%7C+eval+userFullAddress%3Dreplace((%27detail.userEnteredClaimDetails.bankAccountDetails.address.lines%7B%7D%7B%7D%27.%22+%22.upper(%27detail.userEnteredClaimDetails.bankAccountDetails.address.postcode%27))%2C%22%5B%5Cn%5D%22%2C+%22+%22)+%2C%0A++++bankAccountFull%3D(%27detail.userEnteredClaimDetails.bankAccountDetails.sortCode%27.%22+%22.%27detail.userEnteredClaimDetails.bankAccountDetails.accountNumber%27)%2C%0A++++accountHolderName%3Dcoalesce(%27detail.userEnteredClaimDetails.bankAccountDetails.accountHolderName%27%2C+%27detail.userEnteredClaimDetails.bankAccountDetails.companyName%27)%2C%0A++++phoneNumber%3Dreplace(%27detail.userEnteredClaimDetails.ukMobileNumber%27%2C+%22%5Cs%22%2C+%22%22)%2C%0A++++userEmailAddress%3Dlower(%27detail.userEnteredClaimDetails.emailAddress%27)%2C%0A++++submissionType%3Dcoalesce(if(sourcetype%3D%22dg%3Aself-employed-income-support-frontend%3AClaimSubmitted%22%2C+%22webSubmission%22%2C+Null())%2C+if(sourcetype%3D%22dg%3Aself-employed-income-support-stride-frontend%3AClaimSubmitted%22%2C+%22telephonySubmission%22%2C+Null()))%2C%0A++++rawDeviceId%3Dif(auditSource%3D%22self-employed-income-support-frontend%22%2C+%27tags.deviceID%27%2C+null())%2C%0A++++reasonForClaim%3Dcase(%27detail.reasonForClaim%27%3D%3D%22First+Claim%22%2C+%22firstClaim%22%2C+%27detail.reasonForClaim%27%3D%3D%22Reclaim+-+Previous+claim+rejected+by+compliance%22%2C+%22rejectCompliance%22%2C+%27detail.reasonForClaim%27%3D%3D%22Reclaim+-+Payment+Failure%22%2C+%22rejectPaymentFailure%22%2C+%27detail.reasonForClaim%27%3D%3D%22Second+Claim+Reclaim+-+Payment+Failure%22%2C+%22secondClaimRejectPaymentFailure%22%2C+%27detail.reasonForClaim%27%3D%3D%22Second+Claim%22%2C+%22secondClaim%22)%2C%0A++++aRC%3Dcase(%27detail.allowedClaimReason%27%3D%3D%22null%22%2C+%22N%2FA%22%2C+%27detail.allowedClaimReason%27%3D%3D%22Reservist%22%2C+%22reservist%22%2C+%27detail.allowedClaimReason%27%3D%3D%22Parental+Leave%22%2C+%22parentalLeave%22%2C+%27detail.allowedClaimReason%27%3D%3D%22Late+Eligibility+Identified%22%2C+%22lateEligibility%22)%2C%0A++++reasonForClaim%3D(%27reasonForClaim%27.%22_%22.%27aRC%27)%2C%0A++++seissPeriod%3Dcase(%27detail.phase%27%3D%3D%221%22%2C+%22SEISS_1%22%2C+%27detail.phase%27%3D%3D%222%22%2C+%22SEISS_2%22)+%0A%7C+rex+field%3DrawDeviceId+%22(%3F%3CdeviceId%3E%5Cw%7B8%7D(%5C-%5Cw%7B4%7D)%7B3%7D%5C-%5Cw%7B12%7D)%22+%0A%7C+fillnull+reasonForClaim+value%3DN%2FA+%0A%7C+fillnull+detail.changedPersonalDetails+value%3D%22N%2FA%22+%0A%7C+stats+%0A++++earliest(_time)+AS+submissionTime%0A++++values(tags.clientIP)+AS+clientIp%0A++++values(submissionType)+AS+submissionType%0A++++values(detail.riskAssessmentResult)+AS+assessmentResult%0A++++values(detail.changedPersonalDetails)+AS+claimDetailsChanged%0A++++values(rawDeviceId)+AS+rawDevice%0A++++values(deviceId)+AS+deviceId%0A++++values(bankAccountFull)+AS+bankAccountFull%0A++++values(detail.userEnteredClaimDetails.bankAccountDetails.bankOrBuildingSocietyType)+AS+bankType%0A++++values(detail.claimReferenceNumber)+AS+claimRef%0A++++values(seissPeriod)+AS+seissPeriod%0A++++values(reasonForClaim)+AS+reasonForClaim%0A++++values(eval(%27detail.claimDetails.grantAmount%27%2F100))+AS+grantAmount%0A++++values(eval(%27detail.claimDetails.calculationBreakdown.avgTradingProfit%27%2F100))+AS+averageProfit%0A++++values(detail.saUTR)+AS+saUtr%0A++++values(detail.credId)+AS+credId%0A++++values(detail.userType)+AS+userType%0A++++values(userFullAddress)+AS+userFullAddress%0A++++values(detail.userEnteredClaimDetails.fullName)+AS+claimantName%0A++++values(accountHolderName)+AS+accountHolderName%0A++++values(phoneNumber)+AS+phoneNumber%0A++++values(userEmailAddress)+AS+userEmailAddress%0A++++values(detail.userAgentString)+AS+userAgent%0A++++by+_time+tags.X-Session-ID+%0A%7C+eval+assessmentHours%3Dcoalesce(if(assessmentResult%3D%22ACCEPT%22%2C+%2286400%22%2C+null())%2C+if(assessmentResult%3D%22CHECK%22%2C+%22259200%22%2C+null())%2C+if(assessmentResult%3D%22REJECT%22%2C+%220%22%2C+null()))%2C%0A++++hoursToBacsRun%3D(((%27submissionTime%27%2BassessmentHours)-now())%2F3600)%2C+hoursToBacsRun%3Dround(%27hoursToBacsRun%27%2C+0)%2C+%0A++++seissPeriodDepricated%3Dcoalesce(if(_time%3E%3D1588896000+AND+_time%3C%3D1597449600%2C+%22SEISS_1%22%2C+null())%2C+if(_time%3E%3D1597622400+AND+_time%3C%3D1603065600%2C+%22SEISS_2%22%2C+null()))+%0A%7C+convert+timeformat%3D%22%25Y-%25m-%25d+%25H%3A%25M%3A%25S%22+ctime(submissionTime)+%0A%7C+sort+limit%3D0+-submissionTime+%0A%7C+eval+totalPending%3Dif(%27hoursToBacsRun%27%3E%3D0%2C+grantAmount%2C+null())%2C+totalPaid%3Dif(%27hoursToBacsRun%27%3C0%2C+grantAmount%2C+null())+%0A%7C+rename+tags.X-Session-ID+AS+sessionId+%0A%7C+table+_time%2C+sessionId%2C+submissionTime%2C+hoursToBacsRun%2C+clientIp%2C+submissionType%2C+assessmentResult%2C+claimDetailsChanged%2C+rawDevice%2C+bankAccountFull%2C+bankType%2C+claimRef%2C+seissPeriod%2C+reasonForClaim%2C+grantAmount%2C+averageProfit%2C+claimantName%2C+credId%2C+saUtr%2C+userType%2C+userFullAddress%2C+accountHolderName%2C+phoneNumber+userEmailAddress+%0A%7C+eval+seissReferal%3D%22SEISS-B-046%22+%0A%7C+stats+values(seissReferal)+AS+seissReferal+values(rawDevice)+AS+rawDevice+values(saUtr)+AS+saUtr+by+claimRef+%0A%7C+table+seissReferal%2C+null%2C+saUtr%2C+claimRef&useTypeahead=true&useAssistant=false&showCommandHelp=true&showCommandHistory=true&showFieldInfo=false&_=1600066656713
up: down
	docker build -t $(NAME) .
	docker run -d \
		--name $(NAME) \
		-v $(PWD)/nginx.conf:/etc/nginx/nginx.conf \
		-v $(PWD)/redact.lua:/var/lib/nginx/redact.lua \
		-p 8000:80 \
		$(NAME) \
		nginx-debug -g 'daemon off;'
	docker exec -ti $(NAME) echo || $(MAKE) log

log:
	docker logs $(NAME)

test:
	docker exec -ti $(NAME) nginx -s reload
	http -ph GET ":8000/$(URI)"
	docker exec -ti $(NAME) cat /var/log/nginx/host.access.log

shell:
	docker exec -ti $(NAME) ash

down:
	docker rm -f $(NAME) || echo meh
